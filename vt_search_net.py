import requests
import json
import sys
import re
import os

API_KEY = '210e23db350d9fd0864e4ce18d5eda62dc71af12607c9140a18504ee8f651213'

request_headers = {
    'x-apikey': API_KEY,
}

iplist = []
domainlist = []

ipregex = re.compile(r'(?:(?:\d|[01]?\d\d|2[0-4]\d|25[0-5])\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d|\d)(?:\/\d{1,2})?')
domainregex = re.compile(r'\b((?=[a-z0-9-]{1,63}\.)(xn--)?[a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,63}\b')

def parse_ip(iplist):

    for ip in iplist:
            print("\n")
           
            url = "https://www.virustotal.com/api/v3/ip_addresses/" + ip
            r = requests.get(url, headers=request_headers)
            with open("ip.json", 'wb') as f:
                f.write(r.content)
            data = r.json()

            data_dict = data["data"]
            attributes = data_dict["attributes"]
            malicious = attributes["last_analysis_stats"]["malicious"]
            datefrom = attributes["last_https_certificate"]["validity"]["not_before"]
            dateto = attributes["last_https_certificate"]["validity"]["not_after"]

            print("ip:"+str(ip))
            print("malicious:"+str(malicious))
            print("country:"+str(attributes["country"]))
            print("jarm:"+str(attributes["jarm"]))
            print("owner:"+str(attributes["as_owner"]))
            print("asn:"+str(attributes["asn"]))
            print("valid:"+str(datefrom)+" to "+str(dateto))
            print("whois_date:"+str(attributes["whois_date"]))
            print("whois:"+"\n"+str(attributes["whois"]))                


def parse_domain(domainlist):

    for domain in domainlist:
        print("\n")
        
        url = "https://www.virustotal.com/api/v3/domains/" + domain
        r = requests.get(url, headers=request_headers)
        data = r.json()
        with open("domain.json", 'wb') as f:
            f.write(r.content)
            data = r.json()
        
        data_dict = data["data"]
        attributes = data_dict["attributes"]
        last_analysis_stats = attributes["last_analysis_stats"]
        last_https_certificate = attributes["last_https_certificate"]
        datefrom = attributes["last_https_certificate"]["validity"]["not_before"]
        dateto = attributes["last_https_certificate"]["validity"]["not_after"]
        malicious = last_analysis_stats["malicious"]

        print("domain:"+str(domain))
        print("malicious:"+str(malicious))
        print("is_malware:"+str(attributes["total_votes"]["malicious"]))
        #print("country:"+str())
        print("valid:"+str(datefrom)+" to "+str(dateto))
        print("jarm:"+str(attributes["jarm"]))
        print("Subdomains:"+str(last_https_certificate["extensions"]["subject_alternative_name"]))
        print("whois_date:"+str(attributes["whois_date"]))
        print("whois:"+"\n"+str(attributes["whois"]))


with open("net.txt", "r") as f:
    lines = f.readlines()
    f.close()

for line in lines:
    line = line.strip()
    
    match_ipregex = ipregex.match(line)
    if match_ipregex:
        iplist.append(line)
    
    match_domainregex = domainregex.match(line)

    if match_domainregex:
        domainlist.append(line)

    elif not match_ipregex and not match_domainregex:
        print(line + " is probably not a domain or an IP")
        
parse_domain(domainlist)
parse_ip(iplist)

